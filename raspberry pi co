
# Raspberry Pi Pico DHT22 Controller with Manual Override

import machine
import dht
import time

# Pin definitions
DHT_PIN = machine.Pin(15, machine.Pin.IN, machine.Pin.PULL_UP)
FAN_PIN = machine.Pin(16, machine.Pin.OUT)
DEHUMIDIFIER_PIN = machine.Pin(17, machine.Pin.OUT)

# Button definitions
FAN_BUTTON_PIN = machine.Pin(18, machine.Pin.IN, machine.Pin.PULL_UP)
DEHUMIDIFIER_BUTTON_PIN = machine.Pin(19, machine.Pin.IN, machine.Pin.PULL_UP)
MODE_BUTTON_PIN = machine.Pin(20, machine.Pin.IN, machine.Pin.PULL_UP)

# Setpoints
TEMPERATURE_THRESHOLD = 27.0  # Celsius
HUMIDITY_THRESHOLD = 65.0    # %

# State variables
# Modes: "AUTO", "MANUAL"
current_mode = "AUTO"
fan_on = False
dehumidifier_on = False

# Initialize DHT sensor
sensor = dht.DHT22(DHT_PIN)

def read_sensor():
    """Reads temperature and humidity from the DHT22 sensor."""
    try:
        sensor.measure()
        temperature = sensor.temperature()
        humidity = sensor.humidity()
        return temperature, humidity
    except OSError as e:
        print("Failed to read sensor:", e)
        return None, None

def main():
    """Main loop for the controller."""
    global current_mode, fan_on, dehumidifier_on

    last_mode_press = 0
    last_fan_press = 0
    last_dehumidifier_press = 0

    while True:
        # Debounce buttons
        mode_button_pressed = not MODE_BUTTON_PIN.value()
        fan_button_pressed = not FAN_BUTTON_PIN.value()
        dehumidifier_button_pressed = not DEHUMIDIFIER_BUTTON_PIN.value()

        # Mode switching
        if mode_button_pressed and (time.ticks_ms() - last_mode_press > 200):
            last_mode_press = time.ticks_ms()
            if current_mode == "AUTO":
                current_mode = "MANUAL"
                print("Switched to MANUAL mode")
            else:
                current_mode = "AUTO"
                print("Switched to AUTO mode")

        # Sensor reading and automatic control
        temperature, humidity = read_sensor()
        if temperature is not None and humidity is not None:
            print(f"Temp: {temperature}Â°C, Hum: {humidity}%, Mode: {current_mode}")

            if current_mode == "AUTO":
                # Automatic fan control
                if temperature > TEMPERATURE_THRESHOLD:
                    fan_on = True
                else:
                    fan_on = False

                # Automatic dehumidifier control
                if humidity > HUMIDITY_THRESHOLD:
                    dehumidifier_on = True
                else:
                    dehumidifier_on = False
            else: # MANUAL mode
                # Manual fan control
                if fan_button_pressed and (time.ticks_ms() - last_fan_press > 200):
                    last_fan_press = time.ticks_ms()
                    fan_on = not fan_on

                # Manual dehumidifier control
                if dehumidifier_button_pressed and (time.ticks_ms() - last_dehumidifier_press > 200):
                    last_dehumidifier_press = time.ticks_ms()
                    dehumidifier_on = not dehumidifier_on
        
        # Update actuators
        FAN_PIN.value(fan_on)
        DEHUMIDIFIER_PIN.value(dehumidifier_on)

        print(f"Fan: {'ON' if fan_on else 'OFF'}, Dehumidifier: {'ON' if dehumidifier_on else 'OFF'}")

        time.sleep(1)

if __name__ == "__main__":
    main()
